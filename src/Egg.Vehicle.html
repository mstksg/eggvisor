<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds             #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DeriveGeneric         #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts      #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances     #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE GADTs                 #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase            #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings     #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE PolyKinds             #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes            #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards       #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables   #-}</span><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell       #-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE TupleSections         #-}</span><span>
</span><a name="line-15"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications      #-}</span><span>
</span><a name="line-16"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies          #-}</span><span>
</span><a name="line-17"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators         #-}</span><span>
</span><a name="line-18"></a><span class="hs-pragma">{-# LANGUAGE TypeSynonymInstances  #-}</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Egg</span><span class="hs-operator">.</span><span class="hs-identifier">Vehicle</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-21"></a><span>    </span><a href="Egg.Vehicle.html#Vehicle"><span class="hs-identifier hs-type">Vehicle</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#vName"><span class="hs-identifier hs-var">vName</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#vBaseCapacity"><span class="hs-identifier hs-var">vBaseCapacity</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#vCosts"><span class="hs-identifier hs-var">vCosts</span></a><span>
</span><a name="line-22"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#VehicleData"><span class="hs-identifier hs-type">VehicleData</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#_VehicleData"><span class="hs-identifier hs-var">_VehicleData</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#SomeVehicleData"><span class="hs-identifier hs-type">SomeVehicleData</span></a><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#DepotStatus"><span class="hs-identifier hs-type">DepotStatus</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#_DepotStatus"><span class="hs-identifier hs-var">_DepotStatus</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#SomeDepotStatus"><span class="hs-identifier hs-type">SomeDepotStatus</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#_SomeDepotStatus"><span class="hs-identifier hs-var">_SomeDepotStatus</span></a><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#SomeVehicleUpgradeError"><span class="hs-identifier hs-type">SomeVehicleUpgradeError</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#_SVUERegression"><span class="hs-identifier hs-var">_SVUERegression</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#_SVUENoSlot"><span class="hs-identifier hs-var">_SVUENoSlot</span></a><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#withSomeDepotStatus"><span class="hs-identifier hs-var">withSomeDepotStatus</span></a><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#initDepotStatus"><span class="hs-identifier hs-var">initDepotStatus</span></a><span>
</span><a name="line-27"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#initSomeDepotStatus"><span class="hs-identifier hs-var">initSomeDepotStatus</span></a><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#baseDepotCapacity"><span class="hs-identifier hs-var">baseDepotCapacity</span></a><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#totalDepotCapacity"><span class="hs-identifier hs-var">totalDepotCapacity</span></a><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#vehicleHistory"><span class="hs-identifier hs-var">vehicleHistory</span></a><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#vehiclePrice"><span class="hs-identifier hs-var">vehiclePrice</span></a><span>
</span><a name="line-32"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#upgradeVehicle"><span class="hs-identifier hs-var">upgradeVehicle</span></a><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#upgradeSomeVehicle"><span class="hs-identifier hs-var">upgradeSomeVehicle</span></a><span>
</span><a name="line-34"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#vehicleUpgrades"><span class="hs-identifier hs-var">vehicleUpgrades</span></a><span>
</span><a name="line-35"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Vehicle.html#someVehicleUpgrades"><span class="hs-identifier hs-var">someVehicleUpgrades</span></a><span>
</span><a name="line-36"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span> </span><span class="hs-keyword">hiding</span><span>           </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">.=</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Aeson</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Aeson</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Dependent</span><span class="hs-operator">.</span><span class="hs-identifier">Sum</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Finite</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Finite</span><span class="hs-operator">.</span><span class="hs-identifier">Internal</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span class="hs-operator">.</span><span class="hs-identifier">Prelude</span><span class="hs-operator">.</span><span class="hs-identifier">Num</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span class="hs-operator">.</span><span class="hs-identifier">TypeLits</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Combinator</span><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.Vector.Sized.Util.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span class="hs-operator">.</span><span class="hs-identifier">Sized</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span>           </span><a href="Egg.Commodity.html"><span class="hs-identifier">Egg</span><span class="hs-operator">.</span><span class="hs-identifier">Commodity</span></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span>           </span><a href="Egg.Research.html"><span class="hs-identifier">Egg</span><span class="hs-operator">.</span><span class="hs-identifier">Research</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Generics</span><span>                  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Natural</span><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Printf</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span>                      </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">V</span><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span class="hs-operator">.</span><span class="hs-identifier">Sized</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SV</span><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">TypeLits</span><span>                  </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TL</span><span>
</span><a name="line-62"></a><span>
</span><a name="line-63"></a><span class="hs-keyword">data</span><span> </span><a name="Vehicle"><a href="Egg.Vehicle.html#Vehicle"><span class="hs-identifier">Vehicle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Vehicle"><a href="Egg.Vehicle.html#Vehicle"><span class="hs-identifier">Vehicle</span></a></a><span>
</span><a name="line-64"></a><span>        </span><span class="hs-special">{</span><span> </span><a name="_vName"><a href="Egg.Vehicle.html#_vName"><span class="hs-identifier">_vName</span></a></a><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">T</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-65"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="_vBaseCapacity"><a href="Egg.Vehicle.html#_vBaseCapacity"><span class="hs-identifier">_vBaseCapacity</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Natural</span><span>         </span><span class="hs-comment">-- ^ eggs per minute</span><span>
</span><a name="line-66"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="_vCosts"><a href="Egg.Vehicle.html#_vCosts"><span class="hs-identifier">_vCosts</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">V</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Vector</span><span> </span><a href="Egg.Commodity.html#Bock"><span class="hs-identifier hs-type">Bock</span></a><span>
</span><a name="line-67"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-68"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-identifier hs-var">makeLenses</span><span> </span><span class="hs-char">''Vehicle

newtype VehicleData vs = VehicleData { _vdVehicles :: SV.Vector vs Vehicle }
  deriving (Show, Eq, Ord, Generic)

makePrisms ''VehicleData
makeWrapped ''VehicleData

type SomeVehicleData = DSum Sing VehicleData

data DepotStatus vs slots
    = DepotStatus { _dsSlots :: M.Map (Finite slots) (Finite vs) }
  deriving (Show, Eq, Ord, Generic)

makePrisms ''DepotStatus
makeWrapped ''DepotStatus

data SomeVehicleUpgradeError = SVUERegression
                             | SVUENoSlot
  deriving (Show, Eq, Ord)

makePrisms ''SomeVehicleUpgradeError

data SomeDepotStatus vs
    = SomeDepotStatus { _sdsSlots :: M.Map Integer (Finite vs) }
  deriving (Show, Eq, Ord, Generic)

_SomeDepotStatus
    :: Functor f
    =&gt; Bonuses
    -&gt; (forall slots. KnownNat slots =&gt; LensLike' f (DepotStatus vs slots) b)
    -&gt; LensLike' f (SomeDepotStatus vs) b
_SomeDepotStatus bs f g = traverseSomeDepotStatus bs (f g)

withSomeDepotStatus
    :: Bonuses
    -&gt; SomeDepotStatus vs
    -&gt; (forall slots. KnownNat slots =&gt; DepotStatus vs slots -&gt; r)
    -&gt; r
withSomeDepotStatus bs sd f = sd ^. _SomeDepotStatus bs (to f)

traverseSomeDepotStatus
    :: Functor f
    =&gt; Bonuses
    -&gt; (forall slots. KnownNat slots =&gt; DepotStatus vs slots -&gt; f (DepotStatus vs slots))
    -&gt; SomeDepotStatus vs
    -&gt; f (SomeDepotStatus vs)
traverseSomeDepotStatus bs f sds0 = withSomeSing fleetSize $ \(SNat :: Sing slots) -&gt;
    let ds0 = DepotStatus
            . M.mapKeysMonotonic Finite
            . M.filterWithKey (\k _ -&gt; k &lt; fleetSize)
            $ _sdsSlots sds0
    in  SomeDepotStatus . M.mapKeysMonotonic getFinite . _dsSlots
          &lt;$&gt; f @slots ds0
  where
    fleetSize :: Integer
    fleetSize = 4 ^. bonusingFor bs BTFleetSize . to round

vehicleParseOptions :: Options
vehicleParseOptions = defaultOptions
    { fieldLabelModifier = camelTo2 '-' . drop 2
    }

instance FromJSON Vehicle where
    parseJSON  = genericParseJSON  vehicleParseOptions
instance ToJSON Vehicle where
    toJSON     = genericToJSON     vehicleParseOptions
    toEncoding = genericToEncoding vehicleParseOptions

instance FromJSON SomeVehicleData where
    parseJSON o = do
      vs &lt;- parseJSON o
      SV.withSized vs $ \vsV -&gt;
        return $ SNat :=&gt; VehicleData vsV
instance ToJSON SomeVehicleData where
    toJSON = \case
        _ :=&gt; r -&gt; toJSON r
    toEncoding = \case
        _ :=&gt; r -&gt; toEncoding r
instance KnownNat vs =&gt; FromJSON (VehicleData vs) where
    parseJSON o = do
      vs &lt;- parseJSON o
      case SV.toSized vs of
        Nothing  -&gt; fail $ printf &quot;Bad number of items in list. (Expected %d, got %d)&quot;
                         (fromSing (SNat @vs)) (length vs)
        Just vsV -&gt; return $ VehicleData vsV
instance ToJSON (VehicleData habs) where
    toJSON     = toJSON     . SV.fromSized . _vdVehicles
    toEncoding = toEncoding . SV.fromSized . _vdVehicles

-- | Initial 'DepotStatus' to start off the game.
initDepotStatus :: (KnownNat vs, KnownNat slots, 1 TL.&lt;= vs, 1 TL.&lt;= slots) =&gt; DepotStatus vs slots
initDepotStatus = DepotStatus $ M.singleton 0 0

-- | Initial 'SomeDepotStatus' to start off the game.
initSomeDepotStatus :: (KnownNat vs, 1 TL.&lt;= vs) =&gt; SomeDepotStatus vs
initSomeDepotStatus = SomeDepotStatus $ M.singleton 0 0

-- | Total base capacity of all slots, in eggs per second.
baseDepotCapacity
    :: forall vs slots. KnownNat vs
    =&gt; VehicleData vs
    -&gt; DepotStatus vs slots
    -&gt; Double
baseDepotCapacity VehicleData{..} =
    sumOf $ _DepotStatus
          . folded
          . to (SV.index _vdVehicles)
          . vBaseCapacity
          . to fromIntegral
          . dividing 60

-- | Total capacity of all vehicles, factoring in bonuses.
totalDepotCapacity
    :: forall vs slots. KnownNat vs
    =&gt; VehicleData vs
    -&gt; Bonuses
    -&gt; DepotStatus vs slots
    -&gt; Double
totalDepotCapacity vd@VehicleData{..} bs =
    sumOf $ to (baseDepotCapacity vd)
          . bonusingFor bs BTVehicleCapacity
          . bonusingFor bs BTVehicleSpeed

-- | How many of each vehicle has been purchased so far.  If key is not found,
-- zero purchases is implied.
vehicleHistory
    :: KnownNat (slots TL.+ 1)
    =&gt; DepotStatus vs slots
    -&gt; M.Map (Finite vs) (Finite (slots TL.+ 1))
vehicleHistory = M.fromListWith (+)
               . toListOf (_DepotStatus . folded . to (, 1))

-- | Get the BASE price of a given vehicle, if a purchase were to be made.
-- Does not check if purchase is legal (see 'upgradeVehicle').
vehiclePrice
    :: forall vs slots. (KnownNat vs, KnownNat slots)
    =&gt; VehicleData vs
    -&gt; DepotStatus vs slots
    -&gt; Finite vs
    -&gt; Maybe Bock
vehiclePrice vd ds v = withKnownNat (SNat @slots %:+ SNat @1) $
                           fmap priceOf
                         . strengthen
                         . fromMaybe 0
                         . M.lookup v
                         . vehicleHistory
                         $ ds
  where
    priceOf :: Finite slots -&gt; Bock
    priceOf i = fromMaybe 0 $
                  vd ^? _VehicleData . ixSV v . vCosts . ix (fromIntegral i)

-- | Purchase a vehicle upgrade.  Returns cost and new depot status,
-- if purchase is valid.
--
-- Purchase is invalid if purchasing a vehicle in a slot where a greater
-- vehicle is already purchased.
upgradeVehicle
    :: (KnownNat vs, KnownNat slots)
    =&gt; VehicleData vs
    -&gt; Bonuses
    -&gt; Finite slots
    -&gt; Finite vs
    -&gt; DepotStatus vs slots
    -&gt; Maybe (Bock, DepotStatus vs slots)
upgradeVehicle vd bs slot v ds0 =
    getComp . flip (_DepotStatus . at slot) ds0 $ \s0 -&gt; Comp $ do
      guard $ case s0 of
                Nothing -&gt; True
                Just h  -&gt; h &lt; v
      -- should always be valid of the previous condition is true
      price &lt;- vehiclePrice vd ds0 v
      return (price ^. bonusingFor bs BTVehicleCosts, Just v)

-- | Purchase a vehicle upgrade.  Returns cost and new depot status,
-- if purchase is valid.
--
-- Purchase is invalid if purchasing a vehicle in a slot where a greater
-- vehicle is already purchased, and also if there is no such slot.
upgradeSomeVehicle
    :: forall vs. KnownNat vs
    =&gt; VehicleData vs
    -&gt; Bonuses
    -&gt; Integer
    -&gt; Finite vs
    -&gt; SomeDepotStatus vs
    -&gt; Either SomeVehicleUpgradeError (Bock, SomeDepotStatus vs)
upgradeSomeVehicle vd bs slot v sds0 =
    getComp . traverseSomeDepotStatus bs (Comp . go) $ sds0
  where
    go  :: KnownNat slots
        =&gt; DepotStatus vs slots
        -&gt; Either SomeVehicleUpgradeError (Bock, DepotStatus vs slots)
    go ds0 = case packFinite slot of
      Nothing    -&gt; Left SVUENoSlot
      Just slot' -&gt; maybe (Left SVUERegression) Right $
                      upgradeVehicle vd bs slot' v ds0

-- | List all possible vehicle upgrades.
vehicleUpgrades
    :: forall vs slots. KnownNat slots
    =&gt; VehicleData vs
    -&gt; Bonuses
    -&gt; DepotStatus vs slots
    -&gt; (SV.Vector slots :.: SV.Vector vs :.: Maybe) Bock
vehicleUpgrades vd bs ds = Comp . Comp $ SV.generate go
  where
    slots1 = SNat @slots %:+ SNat @1
    hist :: M.Map (Finite vs) (Finite (slots TL.+ 1))
    hist = withKnownNat slots1 $
             vehicleHistory ds
    go :: Finite slots -&gt; SV.Vector vs (Maybe Bock)
    go s = vd ^. _VehicleData
              &amp; SV.imap
                  (\j h -&gt; withKnownNat slots1 $ do
                      guard (Just j &gt; currVeh)
                      let n = M.findWithDefault 0 j hist
                      h ^? vCosts . ix (fromIntegral n) . bonusingFor bs BTVehicleCosts
                  )
      where
        currVeh = ds ^? _DepotStatus . ix s

-- | List all possible vehicle upgrades for a 'SomeDepotStatus'.
someVehicleUpgrades
    :: forall vs. ()
    =&gt; VehicleData vs
    -&gt; Bonuses
    -&gt; SomeDepotStatus vs
    -&gt; (M.Map Integer :.: SV.Vector vs) (Maybe Bock)
someVehicleUpgrades vd bs = view $ _SomeDepotStatus bs go
                                 . _Unwrapped
  where
    go  :: KnownNat slots
        =&gt; Getter (DepotStatus vs slots) (M.Map Integer (SV.Vector vs (Maybe Bock)))
    go = to (vehicleUpgrades vd bs)
       . _Wrapped
       . _Wrapped
       . to (itoListOf ifolded)
       . to (over (mapped . _1) fromIntegral)
       . to M.fromAscList
</span></pre></body></html>