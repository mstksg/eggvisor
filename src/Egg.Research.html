<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds                            #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DeriveGeneric                        #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts                     #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances                    #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE FunctionalDependencies               #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE GADTs                                #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE KindSignatures                       #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase                           #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses                #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE OverloadedStrings                    #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE PartialTypeSignatures                #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE PolyKinds                            #-}</span><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes                           #-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards                      #-}</span><span>
</span><a name="line-15"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables                  #-}</span><span>
</span><a name="line-16"></a><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving                   #-}</span><span>
</span><a name="line-17"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell                      #-}</span><span>
</span><a name="line-18"></a><span class="hs-pragma">{-# LANGUAGE TupleSections                        #-}</span><span>
</span><a name="line-19"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications                     #-}</span><span>
</span><a name="line-20"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies                         #-}</span><span>
</span><a name="line-21"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators                        #-}</span><span>
</span><a name="line-22"></a><span class="hs-pragma">{-# LANGUAGE TypeSynonymInstances                 #-}</span><span>
</span><a name="line-23"></a><span class="hs-pragma">{-# LANGUAGE UndecidableInstances                 #-}</span><span>
</span><a name="line-24"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns                         #-}</span><span>
</span><a name="line-25"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-partial-type-signatures #-}</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Egg</span><span class="hs-operator">.</span><span class="hs-identifier">Research</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-28"></a><span>    </span><a href="Egg.Research.html#BonusAmount"><span class="hs-identifier hs-type">BonusAmount</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#AsBonusAmount"><span class="hs-identifier hs-type">AsBonusAmount</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#BonusType"><span class="hs-identifier hs-type">BonusType</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#AsBonusType"><span class="hs-identifier hs-type">AsBonusType</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#Bonuses"><span class="hs-identifier hs-type">Bonuses</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#_Bonuses"><span class="hs-identifier hs-var">_Bonuses</span></a><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#Research"><span class="hs-identifier hs-type">Research</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#HasResearch"><span class="hs-identifier hs-type">HasResearch</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#ResearchTier"><span class="hs-identifier hs-type">ResearchTier</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#rtUnlock"><span class="hs-identifier hs-var">rtUnlock</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#rtTechs"><span class="hs-identifier hs-var">rtTechs</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#SomeResearchTier"><span class="hs-identifier hs-type">SomeResearchTier</span></a><span>
</span><a name="line-33"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#ResearchData"><span class="hs-identifier hs-type">ResearchData</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#rdCommon"><span class="hs-identifier hs-var">rdCommon</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#rdEpic"><span class="hs-identifier hs-var">rdEpic</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#SomeResearchData"><span class="hs-identifier hs-type">SomeResearchData</span></a><span>
</span><a name="line-34"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#ResearchStatus"><span class="hs-identifier hs-type">ResearchStatus</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#rsCommon"><span class="hs-identifier hs-var">rsCommon</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#rsEpic"><span class="hs-identifier hs-var">rsEpic</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#SomeResearchStatus"><span class="hs-identifier hs-type">SomeResearchStatus</span></a><span>
</span><a name="line-35"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#ResearchIx"><span class="hs-identifier hs-type">ResearchIx</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#_RICommon"><span class="hs-identifier hs-var">_RICommon</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#_RIEpic"><span class="hs-identifier hs-var">_RIEpic</span></a><span>
</span><a name="line-36"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#ResearchError"><span class="hs-identifier hs-type">ResearchError</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#_REMaxedOut"><span class="hs-identifier hs-var">_REMaxedOut</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#_RELocked"><span class="hs-identifier hs-var">_RELocked</span></a><span>
</span><a name="line-37"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#scaleAmount"><span class="hs-identifier hs-var">scaleAmount</span></a><span>
</span><a name="line-38"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#hasEffect"><span class="hs-identifier hs-var">hasEffect</span></a><span>
</span><a name="line-39"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#bonusEffect"><span class="hs-identifier hs-var">bonusEffect</span></a><span>
</span><a name="line-40"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#bonusEffectFor"><span class="hs-identifier hs-var">bonusEffectFor</span></a><span>
</span><a name="line-41"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#bonusing"><span class="hs-identifier hs-var">bonusing</span></a><span>
</span><a name="line-42"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#bonusingFor"><span class="hs-identifier hs-var">bonusingFor</span></a><span>
</span><a name="line-43"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#emptyBonuses"><span class="hs-identifier hs-var">emptyBonuses</span></a><span>
</span><a name="line-44"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#bonuses"><span class="hs-identifier hs-var">bonuses</span></a><span>
</span><a name="line-45"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#maxLevel"><span class="hs-identifier hs-var">maxLevel</span></a><span>
</span><a name="line-46"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#emptyResearchStatus"><span class="hs-identifier hs-var">emptyResearchStatus</span></a><span>
</span><a name="line-47"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#researchBonuses"><span class="hs-identifier hs-var">researchBonuses</span></a><span>
</span><a name="line-48"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#totalBonuses"><span class="hs-identifier hs-var">totalBonuses</span></a><span>
</span><a name="line-49"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#researchCount"><span class="hs-identifier hs-var">researchCount</span></a><span>
</span><a name="line-50"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#legalTiers"><span class="hs-identifier hs-var">legalTiers</span></a><span>
</span><a name="line-51"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#foldResearch"><span class="hs-identifier hs-var">foldResearch</span></a><span>
</span><a name="line-52"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#purchaseResearch"><span class="hs-identifier hs-var">purchaseResearch</span></a><span>
</span><a name="line-53"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#researchIxNum"><span class="hs-identifier hs-var">researchIxNum</span></a><span>
</span><a name="line-54"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#researchIxData"><span class="hs-identifier hs-var">researchIxData</span></a><span>
</span><a name="line-55"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#researchIxStatus"><span class="hs-identifier hs-var">researchIxStatus</span></a><span>
</span><a name="line-56"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#researchIxStatusLegal"><span class="hs-identifier hs-var">researchIxStatusLegal</span></a><span>
</span><a name="line-57"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#withSomeResearch"><span class="hs-identifier hs-var">withSomeResearch</span></a><span>
</span><a name="line-58"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#researchIxesCommon"><span class="hs-identifier hs-var">researchIxesCommon</span></a><span>
</span><a name="line-59"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#researchIxesEpic"><span class="hs-identifier hs-var">researchIxesEpic</span></a><span>
</span><a name="line-60"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#legalResearchIxesCommon"><span class="hs-identifier hs-var">legalResearchIxesCommon</span></a><span>
</span><a name="line-61"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#legalResearchIxesEpic"><span class="hs-identifier hs-var">legalResearchIxesEpic</span></a><span>
</span><a name="line-62"></a><span>  </span><span class="hs-comment">-- * Why?</span><span>
</span><a name="line-63"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#rdrsCommon"><span class="hs-identifier hs-var">rdrsCommon</span></a><span>
</span><a name="line-64"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#rdrsEpic"><span class="hs-identifier hs-var">rdrsEpic</span></a><span>
</span><a name="line-65"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Research.html#researchIx"><span class="hs-identifier hs-var">researchIx</span></a><span>
</span><a name="line-66"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Applicative</span><span> </span><span class="hs-keyword">hiding</span><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">some</span><span class="hs-special">)</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span> </span><span class="hs-keyword">hiding</span><span>             </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">.=</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-type">:&lt;</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Index</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Trans</span><span class="hs-operator">.</span><span class="hs-identifier">Writer</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Aeson</span><span class="hs-operator">.</span><span class="hs-identifier">Encoding</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Aeson</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Bifunctor</span><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Dependent</span><span class="hs-operator">.</span><span class="hs-identifier">Sum</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Finite</span><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Foldable</span><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Kind</span><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Monoid</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier hs-type">First</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span class="hs-operator">.</span><span class="hs-identifier">Prelude</span><span> </span><span class="hs-keyword">hiding</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Flip</span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span class="hs-operator">.</span><span class="hs-identifier">TypeLits</span><span>
</span><a name="line-83"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Combinator</span><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Combinator</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.Type.Combinator.Util.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Combinator</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Conjunction</span><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Index</span><span>
</span><a name="line-88"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Product</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TCP</span><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Sum</span><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span>
</span><a name="line-91"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.Vector.Sized.Util.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span class="hs-operator">.</span><span class="hs-identifier">Sized</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span>           </span><a href="Egg.Commodity.html"><span class="hs-identifier">Egg</span><span class="hs-operator">.</span><span class="hs-identifier">Commodity</span></a><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">Generics</span><span>                    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Natural</span><span>
</span><a name="line-96"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Higher</span><span>
</span><a name="line-97"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Witness</span><span>
</span><a name="line-98"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Family</span><span class="hs-operator">.</span><span class="hs-identifier">Tuple</span><span>
</span><a name="line-99"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span>                        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span>                       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">V</span><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span class="hs-operator">.</span><span class="hs-identifier">Sized</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SV</span><span>
</span><a name="line-103"></a><span>
</span><a name="line-104"></a><span class="hs-keyword">data</span><span> </span><a name="BonusAmount"><a href="Egg.Research.html#BonusAmount"><span class="hs-identifier">BonusAmount</span></a></a><span>
</span><a name="line-105"></a><span>    </span><span class="hs-comment">-- | Bonus adds an absolute amount.  Scales by multiplication, and</span><span>
</span><a name="line-106"></a><span>    </span><span class="hs-comment">-- compounds by addition.</span><span>
</span><a name="line-107"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="BAIncrement"><a href="Egg.Research.html#BAIncrement"><span class="hs-identifier">BAIncrement</span></a></a><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-108"></a><span>    </span><span class="hs-comment">-- | Bonus adds a percentage point multiplier.  Scales by</span><span>
</span><a name="line-109"></a><span>    </span><span class="hs-comment">-- multiplication (three 10% buffs is a 15% buff) and compounds by</span><span>
</span><a name="line-110"></a><span>    </span><span class="hs-comment">-- appropriate multiplication.</span><span>
</span><a name="line-111"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="BAPercent"><a href="Egg.Research.html#BAPercent"><span class="hs-identifier">BAPercent</span></a></a><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-112"></a><span>    </span><span class="hs-comment">-- | Bonus multiplies by a given ratio.  Scales by exponentiation</span><span>
</span><a name="line-113"></a><span>    </span><span class="hs-comment">-- (three 2x buffs is a 8x buff) and compounds by multiplication.</span><span>
</span><a name="line-114"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="BAMultiplier"><a href="Egg.Research.html#BAMultiplier"><span class="hs-identifier">BAMultiplier</span></a></a><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-115"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-116"></a><span>
</span><a name="line-117"></a><span class="hs-identifier hs-var">makeClassyPrisms</span><span> </span><span class="hs-char">''BonusAmount

data BonusType =
        BTBuildCosts
      | BTDroneRewards
      | BTEggValue
      | BTFarmValue
      | BTFleetSize
      | BTHabCapacity
      | BTHatcheryCapacity
      | BTHatcheryRate
      | BTHoldingHatch
      | BTHoverVehicleCapacity
      | BTInternalHatchery
      | BTInternalHatcheryCalm
      | BTInternalHatcherySharing
      | BTLayingRate
      | BTLongWarpTime
      | BTMaxRunningBonus
      | BTPrestigeEggs
      | BTResearchCosts
      | BTRunningBonus
      | BTSiloQuality
      | BTSoulEggBonus
      | BTVehicleCapacity
      | BTVehicleCosts
      | BTVideoDoublerTime
      | BTVehicleSpeed
  deriving (Show, Eq, Ord, Generic)

makeClassyPrisms ''BonusType

newtype Bonuses = Bonuses { _bMap :: M.Map BonusType [BonusAmount] }
    deriving (Show, Eq, Ord)

makePrisms ''Bonuses
makeWrapped ''Bonuses

data Research a =
    Research { _rName        :: T.Text
             , _rDescription :: T.Text
             , _rBaseBonuses :: Bonuses
             -- | 'Left' if no cost data, just giving the maximum level.
             -- 'Right' with cost data.
             , _rCosts       :: Either Natural (V.Vector a)
             }
  deriving (Show, Eq, Ord, Generic)

makeClassy ''Research

data ResearchTier :: Nat -&gt; Type where
    ResearchTier
        :: { _rtUnlock :: Natural
           , _rtTechs  :: SV.Vector n (Research Bock)
           }
        -&gt; ResearchTier n
  deriving (Show, Eq, Ord, Generic)

makeLenses ''ResearchTier

type SomeResearchTier = DSum Sing ResearchTier

data ResearchData :: [Nat] -&gt; Nat -&gt; Type where
    ResearchData
        :: { _rdCommon :: Prod ResearchTier tiers
           , _rdEpic   :: SV.Vector epic (Research GoldenEgg)
           }
        -&gt; ResearchData tiers epic
  deriving (Show, Eq, Ord)

makeLenses ''ResearchData

type SomeResearchData = DSum Sing (Uncur ResearchData)

data ResearchStatus :: [Nat] -&gt; Nat -&gt; Type where
    ResearchStatus
        :: { _rsCommon :: Prod (Flip SV.Vector Natural) tiers
           , _rsEpic   :: SV.Vector epic Natural
           }
        -&gt; ResearchStatus tiers epic
  deriving (Show, Eq, Ord)

makeLenses ''ResearchStatus

type SomeResearchStatus = DSum Sing (Uncur ResearchStatus)

-- | A safe index for a given research item, usable with 'ResearchData' and
-- 'ResearchStatus'.
data ResearchIx :: [Nat] -&gt; Nat -&gt; Type -&gt; Type where
    RICommon :: Sum Finite tiers -&gt; ResearchIx tiers epic Bock
    RIEpic   :: Finite epic      -&gt; ResearchIx tiers epic GoldenEgg

deriving instance Show (Sum Finite tiers) =&gt; Show (ResearchIx tiers epic a)

_RICommon :: Iso (ResearchIx t1 epic Bock) (ResearchIx t2 epic Bock)
                 (Sum Finite t1          ) (Sum Finite t2          )
_RICommon = iso (\case RICommon i -&gt; i) RICommon

_RIEpic :: Iso (ResearchIx tiers e1 GoldenEgg) (ResearchIx tiers e2 GoldenEgg)
               (Finite e1                    ) (Finite e2                    )
_RIEpic = iso (\case RIEpic i -&gt; i) RIEpic

bonusAmountParseOptions :: Options
bonusAmountParseOptions = defaultOptions
    { sumEncoding = TaggedObject
                      { tagFieldName      = &quot;type&quot;
                      , contentsFieldName = &quot;value&quot;
                      }
    , constructorTagModifier = camelTo2 '-' . drop 2
    }

instance FromJSON BonusAmount where
    parseJSON  = genericParseJSON  bonusAmountParseOptions
instance ToJSON BonusAmount where
    toJSON     = genericToJSON     bonusAmountParseOptions
    toEncoding = genericToEncoding bonusAmountParseOptions

bonusTypeParseOptions :: Options
bonusTypeParseOptions = defaultOptions
    { sumEncoding = UntaggedValue
    , constructorTagModifier = camelTo2 '-' . drop 2
    }

instance FromJSON BonusType where
    parseJSON  = genericParseJSON  bonusTypeParseOptions
instance ToJSON BonusType where
    toJSON     = genericToJSON     bonusTypeParseOptions
    toEncoding = genericToEncoding bonusTypeParseOptions
instance FromJSONKey BonusType where
    fromJSONKey = FromJSONKeyTextParser (parseJSON . String)
instance ToJSONKey BonusType where
    toJSONKey = toJSONKeyText $
        T.pack . constructorTagModifier bonusTypeParseOptions . show

instance Monoid Bonuses where
    mempty = Bonuses M.empty
    mappend (Bonuses x) (Bonuses y) =
      Bonuses (M.unionWith (++) x y)

instance FromJSON a =&gt; FromJSON (Research a) where
    parseJSON = withObject &quot;Research&quot; $ \v -&gt;
        Research &lt;$&gt; v .: &quot;name&quot;
                 &lt;*&gt; v .: &quot;description&quot;
                 &lt;*&gt; (mkBase =&lt;&lt; v .: &quot;bonuses&quot;)
                 &lt;*&gt; (Left &lt;$&gt; (v .: &quot;levels&quot;) &lt;|&gt; Right &lt;$&gt; (v .: &quot;costs&quot;))
      where
        mkBase :: M.Map BonusType Object -&gt; Parser Bonuses
        mkBase = fmap (Bonuses . fmap (:[])) . traverse (.: &quot;base-amount&quot;)

instance ToJSON a =&gt; ToJSON (Research a) where
    toJSON Research{..} = object
        [ &quot;name&quot;        .= _rName
        , &quot;description&quot; .= _rDescription
        , &quot;bonuses&quot;     .= object [ &quot;base-amount&quot; .= _bMap _rBaseBonuses ]
        , case _rCosts of Left  l  -&gt; &quot;levels&quot; .= l
                          Right cs -&gt; &quot;costs&quot;  .= cs
        ]
    toEncoding Research{..} = pairs . mconcat $
        [ &quot;name&quot;        .= _rName
        , &quot;description&quot; .= _rDescription
        , pair &quot;bonuses&quot; (pairs (&quot;base-amount&quot; .= _bMap _rBaseBonuses))
        , case _rCosts of Left  l  -&gt; &quot;levels&quot; .= l
                          Right cs -&gt; &quot;costs&quot;  .= cs
        ]

researchTierParseOptions :: Options
researchTierParseOptions = defaultOptions
    { fieldLabelModifier = camelTo2 '-' . drop 3
    }

instance KnownNat n =&gt; FromJSON (ResearchTier n) where
    parseJSON  = genericParseJSON  researchTierParseOptions
instance KnownNat n =&gt; ToJSON (ResearchTier n) where
    toJSON     = genericToJSON     researchTierParseOptions
    toEncoding = genericToEncoding researchTierParseOptions
instance FromJSON SomeResearchTier where
    parseJSON = withObject &quot;ResearchTier&quot; $ \v -&gt; do
      u &lt;- v .: &quot;unlock&quot;
      t &lt;- v .: &quot;techs&quot;
      SV.withSized t $ \tV -&gt;
        return $ sing :=&gt; ResearchTier u tV
instance ToJSON SomeResearchTier where
    toJSON = \case
        SNat :=&gt; r -&gt; toJSON r
    toEncoding = \case
        SNat :=&gt; r -&gt; toEncoding r
instance FromJSON SomeResearchData where
    parseJSON = withObject &quot;ResearchData&quot; $ \v -&gt; do
        res   &lt;- v .: &quot;common&quot;
        epics &lt;- v .: &quot;epic&quot;
        withV res $ \resV -&gt;
          some (withProd (dsumSome . getI) resV) $ \(_ :&amp;: (unzipP-&gt;(resS :&amp;: resP))) -&gt;
            SV.withSized epics   $ \sizedV -&gt;
              return (STuple2 (prodSing resS) SNat :=&gt; Uncur (ResearchData resP sizedV))
instance ToJSON SomeResearchData where
    toJSON = \case
        _ :=&gt; Uncur r -&gt; toJSON r
    toEncoding = \case
        _ :=&gt; Uncur r -&gt; toEncoding r
instance (SingI tiers, KnownNat epic) =&gt; FromJSON (ResearchData tiers epic) where
    parseJSON = withObject &quot;ResearchData&quot; $ \v -&gt; do
        res   &lt;- v .: &quot;common&quot;
        resV  &lt;- go sing res
        epics &lt;- v .: &quot;epic&quot;
        epicsV &lt;- case SV.toSized epics of
          Nothing -&gt; fail &quot;Bad number of items in list.&quot;
          Just eV -&gt; return eV
        return $ ResearchData resV epicsV
      where
        go :: Sing ts -&gt; [Value] -&gt; Parser (Prod ResearchTier ts)
        go = \case
          SNil -&gt; \case
            []  -&gt; return &#216;
            _:_ -&gt; fail &quot;Too many items in list&quot;
          SNat `SCons` ss -&gt; \case
            []   -&gt; fail &quot;Too few items in list&quot;
            x:xs -&gt; (:&lt;) &lt;$&gt; parseJSON x &lt;*&gt; go ss xs

instance ToJSON (ResearchData tiers epic) where
    toJSON ResearchData{..} = object
        [ &quot;common&quot; .= TCP.toList (\ResearchTier{..} -&gt;
                          object [ &quot;unlock&quot; .= _rtUnlock
                                 , &quot;techs&quot;  .= SV.fromSized _rtTechs
                                 ]
                        ) _rdCommon
        , &quot;epic&quot;   .= SV.fromSized _rdEpic
        ]
    toEncoding ResearchData{..} = pairs . mconcat $
        [ &quot;common&quot; .= TCP.toList (\ResearchTier{..} -&gt;
                          object [ &quot;unlock&quot; .= _rtUnlock
                                 , &quot;techs&quot;  .= SV.fromSized _rtTechs
                                 ]
                        ) _rdCommon
        , &quot;epic&quot;   .= SV.fromSized _rdEpic
        ]


-- | Scales a bonus amount by a &quot;level&quot;.
scaleAmount :: Natural -&gt; BonusAmount -&gt; BonusAmount
scaleAmount n = \case
    BAIncrement  i -&gt; BAIncrement  (fromIntegral n * i)
    BAPercent    p -&gt; BAPercent    (fromIntegral n * p)
    BAMultiplier r -&gt; BAMultiplier (r ^ n)

-- | Tells whether or not a bonus amount creates any actual effect.
hasEffect :: BonusAmount -&gt; Bool
hasEffect = \case
    BAIncrement  i -&gt; i /= 0
    BAPercent    p -&gt; p /= 0
    BAMultiplier r -&gt; r /= 1

-- | A &quot;smart constructor&quot; that clears bonuses with no effect.
bonuses :: M.Map BonusType [BonusAmount] -&gt; Bonuses
bonuses = Bonuses . M.filter (not . null) . fmap (filter hasEffect)

-- | Apply a list of bonuses (from left to right) to a value.
bonusEffect :: [BonusAmount] -&gt; Double -&gt; Double
bonusEffect = flip . foldl' $ \e -&gt; \case
    BAIncrement  i -&gt; e + i
    BAPercent    p -&gt; e * (1 + p / 100)
    BAMultiplier r -&gt; e * r

-- | Iso on a value under a list of bonuses (from left to right).
bonusing :: [BonusAmount] -&gt; Iso' Double Double
bonusing = flip foldl' id $ \e -&gt; \case
             BAIncrement i  -&gt; e . adding i
             BAPercent   p  -&gt; e . multiplying (1 + p / 100)
             BAMultiplier r -&gt; e . multiplying r

-- | Iso on a value under the bonuses of a given bonus type.
bonusingFor
    :: Bonuses
    -&gt; BonusType
    -&gt; Iso' Double Double
bonusingFor bs bt = case M.lookup bt (_bMap bs) of
                      Nothing -&gt; id
                      Just bl -&gt; bonusing bl

-- | Apply bonuses for a given type on a value.
bonusEffectFor :: Bonuses -&gt; BonusType -&gt; Double -&gt; Double
bonusEffectFor bs bt = maybe id bonusEffect $ M.lookup bt (_bMap bs)

-- | No bonuses
emptyBonuses :: Bonuses
emptyBonuses = Bonuses M.empty

-- | Maximum level for a given research.
maxLevel :: Research a -&gt; Natural
maxLevel = either fromIntegral (fromIntegral . V.length) . _rCosts

-- | Empty status (no research).
emptyResearchStatus :: ResearchData tiers epic -&gt; ResearchStatus tiers epic
emptyResearchStatus ResearchData{..} =
    ResearchStatus (map1 clear _rdCommon) (0 &lt;$ _rdEpic)
  where
    clear :: ResearchTier a -&gt; Flip SV.Vector Natural a
    clear = Flip . set mapped 0 . view rtTechs

-- | Zips together all research data and research statuses into an
-- accumulator.
foldResearch
    :: Monoid b
    =&gt; (Either (Research Bock) (Research GoldenEgg) -&gt; Natural -&gt; b)
    -&gt; ResearchData tiers epic
    -&gt; ResearchStatus tiers epic
    -&gt; b
foldResearch f ResearchData{..} ResearchStatus{..} = mconcat
    [ foldMap1 (\case d :&amp;: Flip s -&gt; fold $ SV.zipWith (f . Left) (_rtTechs d) s
               )
        (zipP (_rdCommon :&amp;: _rsCommon))
    , fold $ SV.zipWith (f . Right) _rdEpic _rsEpic
    ]

-- | Bonuses from a given 'Research' at a given level.  Assumes no &quot;maximum
-- level&quot;.
researchBonuses :: Research a -&gt; Natural -&gt; Bonuses
researchBonuses _ 0 = Bonuses M.empty
researchBonuses r l = _rBaseBonuses r &amp; _Bonuses . mapped . mapped %~ scaleAmount l

-- | Total bonuses from a given 'ResearchStatus'.
totalBonuses :: ResearchData tiers epic -&gt; ResearchStatus tiers epic -&gt; Bonuses
totalBonuses = foldResearch (either researchBonuses researchBonuses)

-- | How many common techs have been researched?
--
-- Used for opening tiers.
researchCount :: ResearchStatus tiers epic -&gt; Natural
researchCount = sumOf $ rsCommon . liftTraversal (_Flip . folded)

legalTiers
    :: forall tiers epic. ()
    =&gt; ResearchData tiers epic
    -&gt; ResearchStatus tiers epic
    -&gt; Prod (C Bool) tiers
legalTiers rd rs = rd ^. rdCommon . to (map1 go)
  where
    tot = researchCount rs
    go  :: ResearchTier a
        -&gt; C Bool a
    go = view $ rtUnlock . to (&gt;= tot) . _Unwrapped

data ResearchError = REMaxedOut
                   | RELocked
  deriving (Show, Eq, Ord)

makePrisms ''ResearchError

-- | Purchase research at a given index, incrementing the counter in the
-- 'ResearchStatus'.  Returns 'Nothing' if research is already maxed out.
purchaseResearch
    :: forall tiers epic a. (KnownNat epic, SingI tiers)
    =&gt; ResearchData tiers epic
    -&gt; ResearchIx tiers epic a
    -&gt; ResearchStatus tiers epic
    -&gt; Either ResearchError (a, ResearchStatus tiers epic)
purchaseResearch rd i rs0 = pp . runWriterT . researchIxStatusLegal rd i (WriterT . go) $ rs0
  where
    bs = totalBonuses rd rs0
    pp :: Maybe (ResearchStatus tiers epic, First a)
        -&gt; Either ResearchError (a, ResearchStatus tiers epic)
    pp Nothing                     = Left REMaxedOut
    pp (Just (_ , First Nothing )) = Left RELocked
    pp (Just (rs, First (Just c))) = case i of
        RICommon _ -&gt; Right (c ^. bonusingFor bs BTResearchCosts, rs)
        RIEpic   _ -&gt; Right (c, rs)
    go :: Natural -&gt; Maybe (Natural, First a)
    go currLevel = second (First . Just) &lt;$&gt; case rd ^. researchIxData i . rCosts of
        Left m   -&gt; (currLevel + 1, 0) &lt;$ guard (currLevel &lt; m)
                        \\ researchIxNum i
        Right cs -&gt; (currLevel + 1,) &lt;$&gt; (cs V.!? fromIntegral (currLevel + 1))

-- | Get a 'Num' instance from a 'ResearchIx'.
researchIxNum :: ResearchIx tiers epic a -&gt; Wit (Num a)
researchIxNum = \case
    RICommon _ -&gt; Wit
    RIEpic   _ -&gt; Wit

-- | A lens into a 'ResearchData', given the appropriate index.
researchIxData
    :: (KnownNat epic, SingI tiers)
    =&gt; ResearchIx tiers epic a
    -&gt; Lens' (ResearchData tiers epic) (Research a)
researchIxData = \case
    RICommon i -&gt; \f -&gt;
      let g :: forall a. _ a -&gt; _ (_ a)
          g x@(slot :&amp;: (_ :&amp;: SNat)) = (_2 . _1 . rtTechs . ixSV slot) f x
      in  rdCommon $ \rs -&gt; map1 fanFst . fanSnd
            &lt;$&gt; sumProd g (i :&amp;: zipP (rs :&amp;: singProd sing))
    RIEpic i   -&gt; rdEpic . ixSV i

-- | A lens into a 'ResearchStatus', given the appropriate index.
researchIxStatus
    :: (KnownNat epic, SingI tiers)
    =&gt; ResearchIx tiers epic a
    -&gt; Lens' (ResearchStatus tiers epic) Natural
researchIxStatus = \case
    RICommon i -&gt; \f -&gt;
      let g :: forall a. _ a -&gt; _ (_ a)
          g x@(slot :&amp;: (_ :&amp;: SNat)) = (_2 . _1 . _Flip . ixSV slot) f x
      in  rsCommon $ \rs -&gt; map1 fanFst . fanSnd
            &lt;$&gt; sumProd g (i :&amp;: zipP (rs :&amp;: singProd sing))
    RIEpic i   -&gt; rsEpic . ixSV i

-- | Lens into both the research data and research status common slots
-- together.
rdrsCommon
    :: Lens' ((Uncur ResearchData :&amp;: Uncur ResearchStatus) (tiers # epic))
             (Prod (ResearchTier :&amp;: Flip SV.Vector Natural) tiers)
rdrsCommon f (Uncur rd :&amp;: Uncur rs) =
    f (zipP (_rdCommon rd :&amp;: _rsCommon rs)) &lt;&amp;&gt; \(unzipP-&gt;(rdc :&amp;: rsc)) -&gt;
      Uncur (rd &amp; rdCommon .~ rdc) :&amp;: Uncur (rs &amp; rsCommon .~ rsc)

-- | Lens into both the research data and research status epic slots
-- together.
rdrsEpic
    :: KnownNat epic
    =&gt; Lens' ((Uncur ResearchData :&amp;: Uncur ResearchStatus) (tiers # epic))
             (SV.Vector epic (Research GoldenEgg, Natural))
rdrsEpic f (Uncur rd :&amp;: Uncur rs) =
    f (liftA2 (,) (_rdEpic rd) (_rsEpic rs)) &lt;&amp;&gt; \rdrs -&gt;
      Uncur (rd &amp; rdEpic .~ fmap fst rdrs) :&amp;: Uncur (rs &amp; rsEpic .~ fmap snd rdrs)

-- | Lens into both a ResearchData and ResearchStatus together, from
-- a given index.
researchIx
    :: (SingI tiers, KnownNat epic)
    =&gt; ResearchIx tiers epic a
    -&gt; Lens' ((Uncur ResearchData :&amp;: Uncur ResearchStatus) (tiers # epic))
             (Research a, Natural)
researchIx = \case
    RICommon i -&gt; \f -&gt;
      let g :: forall a. _ a
            -&gt; _ (_ a)
          g (slot :&amp;: ((c :&amp;: Flip e) :&amp;: SNat)) =
              f (SV.index (_rtTechs c) slot, SV.index e slot) &lt;&amp;&gt; \(d, s) -&gt;
                let c' = c &amp; rtTechs . ixSV slot .~ d
                    e' = e &amp; ixSV slot .~ s
                in  slot :&amp;: ((c' :&amp;: Flip e') :&amp;: SNat)
      in  rdrsCommon $ \rdrs -&gt;
            map1 fanFst . fanSnd &lt;$&gt; sumProd g (i :&amp;: zipP (rdrs :&amp;: singProd sing))
    RIEpic i -&gt; rdrsEpic . ixSV i

withSomeResearch
    :: DSum Sing (Uncur res)
    -&gt; (forall tiers epic. (KnownNat epic, SingI tiers) =&gt; res tiers epic -&gt; r)
    -&gt; r
withSomeResearch = \case
    STuple2 sTs SNat :=&gt; Uncur r -&gt; \f -&gt; withSingI sTs $ f r

-- | Traversal into a given index of a 'ResearchStatus' if the item is in
-- a legal tier.
--
-- Only a legal traversal if the mapping function doesn't change the legal
-- status.
researchIxStatusLegal
    :: (SingI tiers, KnownNat epic)
    =&gt; ResearchData tiers epic
    -&gt; ResearchIx tiers epic a
    -&gt; Traversal' (ResearchStatus tiers epic) Natural
researchIxStatusLegal rd = \case
    RICommon i -&gt; \f rs0 -&gt; getUncur . fanSnd &lt;$&gt;
      let totCount = researchCount rs0
          g :: forall a. _ a -&gt; _ (_ a)
          g x@(slot :&amp;: ((rt :&amp;: _) :&amp;: SNat))
            | _rtUnlock rt &lt;= totCount = (_2 . _1 . _2 . _Flip . ixSV slot) f x
            | otherwise                = pure x
      in  (Uncur rd :&amp;: Uncur rs0) &amp; rdrsCommon %%~ \rtrs -&gt;
            map1 fanFst . fanSnd &lt;$&gt; sumProd g (i :&amp;: zipP (rtrs :&amp;: singProd sing))
    RIEpic i   -&gt; rsEpic . ixSV i

-- | All 'ResearchIx' into common researches.
researchIxesCommon
    :: SingI tiers
    =&gt; Prod (Flip SV.Vector (ResearchIx tiers epic Bock)) tiers
researchIxesCommon = go sing
  where
    go :: Sing ts -&gt; Prod (Flip SV.Vector (ResearchIx ts epic Bock)) ts
    go = \case
      SNil         -&gt; &#216;
      SNat `SCons` ss -&gt;
        let rest = map1 (over (_Flip . mapped . _RICommon) InR) (go ss)
        in  Flip (SV.generate (RICommon . InL)) :&lt; rest

-- | All 'ResearchIx' into epic researches.
researchIxesEpic
    :: KnownNat epic
    =&gt; SV.Vector epic (ResearchIx tiers epic GoldenEgg)
researchIxesEpic = SV.generate RIEpic

-- | All legal 'ResearchIx' for common research.
legalResearchIxesCommon
    :: forall tiers epic. SingI tiers
    =&gt; ResearchData tiers epic
    -&gt; ResearchStatus tiers epic
    -&gt; Prod (Flip SV.Vector (Either ResearchError (ResearchIx tiers epic Bock))) tiers
legalResearchIxesCommon rd rs =
    imap1 (\i -&gt; Flip . go i) (zipP (zipP (_rdCommon rd :&amp;: _rsCommon rs) :&amp;: singProd sing))
  where
    totCount = researchCount rs
    go  :: forall t. ()
        =&gt; Index tiers t
        -&gt; ((ResearchTier :&amp;: Flip SV.Vector Natural) :&amp;: Sing) t
        -&gt; SV.Vector t (Either ResearchError (ResearchIx tiers epic Bock))
    go i ((rt :&amp;: Flip c) :&amp;: SNat)
      | rt ^. rtUnlock &gt; totCount = pure (Left RELocked)
      | otherwise                 =
          let mkIx
                  :: Finite t
                  -&gt; Research Bock
                  -&gt; Natural
                  -&gt; Either ResearchError (ResearchIx tiers epic Bock)
              mkIx j r n
                | n &lt; maxLevel r = Right . RICommon . someSum $ Some (i :&amp;: j)
                | otherwise      = Left REMaxedOut
          in  SV.izipWith mkIx (rt ^. rtTechs) c

-- | All legal 'ResearchIx' for epic research.
--
-- 'Nothing' implies research is maxed-out.
legalResearchIxesEpic
    :: forall tiers epic. KnownNat epic
    =&gt; ResearchData tiers epic
    -&gt; ResearchStatus tiers epic
    -&gt; (SV.Vector epic :.: Maybe) (ResearchIx tiers epic GoldenEgg)
legalResearchIxesEpic rd rs = Comp $ SV.izipWith go (_rdEpic rd) (_rsEpic rs)
  where
    go  :: Finite epic
        -&gt; Research GoldenEgg
        -&gt; Natural
        -&gt; Maybe (ResearchIx tiers epic GoldenEgg)
    go i r n
      | n &lt; maxLevel r = Just . RIEpic $ i
      | otherwise      = Nothing
</span></pre></body></html>