<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds            #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DeriveGeneric        #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE FlexibleInstances    #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE GADTs                #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE KindSignatures       #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables  #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving   #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell      #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators        #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Egg</span><span class="hs-operator">.</span><span class="hs-identifier">Farm</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-13"></a><span>    </span><a href="Egg.Farm.html#FarmStatus"><span class="hs-identifier hs-type">FarmStatus</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#fsEgg"><span class="hs-identifier hs-var">fsEgg</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#fsResearch"><span class="hs-identifier hs-var">fsResearch</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#fsHabs"><span class="hs-identifier hs-var">fsHabs</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#fsDepot"><span class="hs-identifier hs-var">fsDepot</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#fsBocks"><span class="hs-identifier hs-var">fsBocks</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#fsGoldenEggs"><span class="hs-identifier hs-var">fsGoldenEggs</span></a><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#fsSoulEggs"><span class="hs-identifier hs-var">fsSoulEggs</span></a><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#initFarmStatus"><span class="hs-identifier hs-var">initFarmStatus</span></a><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#farmEggValue"><span class="hs-identifier hs-var">farmEggValue</span></a><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#farmLayingRate"><span class="hs-identifier hs-var">farmLayingRate</span></a><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#farmIncome"><span class="hs-identifier hs-var">farmIncome</span></a><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#farmSoulEggBonus"><span class="hs-identifier hs-var">farmSoulEggBonus</span></a><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#farmBonuses"><span class="hs-identifier hs-var">farmBonuses</span></a><span>
</span><a name="line-21"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#waitTilDepotFull"><span class="hs-identifier hs-var">waitTilDepotFull</span></a><span>
</span><a name="line-22"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#stepFarm"><span class="hs-identifier hs-var">stepFarm</span></a><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Egg.Farm.html#stepFarmDT"><span class="hs-identifier hs-var">stepFarmDT</span></a><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-25"></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Trans</span><span class="hs-operator">.</span><span class="hs-identifier">Writer</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Dependent</span><span class="hs-operator">.</span><span class="hs-identifier">Sum</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Finite</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Kind</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span class="hs-operator">.</span><span class="hs-identifier">TypeLits</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Tuple</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Combinator</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Fin</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.Vector.Sized.Util.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span class="hs-operator">.</span><span class="hs-identifier">Sized</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><a href="Egg.Commodity.html"><span class="hs-identifier">Egg</span><span class="hs-operator">.</span><span class="hs-identifier">Commodity</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><a href="Egg.Egg.html"><span class="hs-identifier">Egg</span><span class="hs-operator">.</span><span class="hs-identifier">Egg</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><a href="Egg.GameData.html"><span class="hs-identifier">Egg</span><span class="hs-operator">.</span><span class="hs-identifier">GameData</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><a href="Egg.Habitat.html"><span class="hs-identifier">Egg</span><span class="hs-operator">.</span><span class="hs-identifier">Habitat</span></a><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span>           </span><a href="Egg.Research.html"><span class="hs-identifier">Egg</span><span class="hs-operator">.</span><span class="hs-identifier">Research</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><a href="Egg.Vehicle.html"><span class="hs-identifier">Egg</span><span class="hs-operator">.</span><span class="hs-identifier">Vehicle</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Numeric</span><span class="hs-operator">.</span><span class="hs-identifier">Natural</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Known</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Family</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Family</span><span class="hs-operator">.</span><span class="hs-identifier">Nat</span><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span class="hs-operator">.</span><span class="hs-identifier">Sized</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SV</span><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC</span><span class="hs-operator">.</span><span class="hs-identifier">TypeLits</span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TL</span><span>
</span><a name="line-49"></a><span>
</span><a name="line-50"></a><span class="hs-keyword">data</span><span> </span><a name="FarmStatus"><a href="Egg.Farm.html#FarmStatus"><span class="hs-identifier">FarmStatus</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Nat</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">Nat</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Nat</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Nat</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Nat</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Type</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-51"></a><span>    </span><a name="FarmStatus"><a href="Egg.Farm.html#FarmStatus"><span class="hs-identifier">FarmStatus</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">{</span><span> </span><a name="_fsEgg"><a href="Egg.Farm.html#_fsEgg"><span class="hs-identifier">_fsEgg</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Finite</span><span> </span><a href="#local-6989586621680043737"><span class="hs-identifier hs-type">eggs</span></a><span>
</span><a name="line-52"></a><span>                  </span><span class="hs-special">,</span><span> </span><a name="_fsResearch"><a href="Egg.Farm.html#_fsResearch"><span class="hs-identifier">_fsResearch</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Egg.Research.html#ResearchStatus"><span class="hs-identifier hs-type">ResearchStatus</span></a><span> </span><a href="#local-6989586621680043738"><span class="hs-identifier hs-type">tiers</span></a><span> </span><a href="#local-6989586621680043739"><span class="hs-identifier hs-type">epic</span></a><span>
</span><a name="line-53"></a><span>                  </span><span class="hs-special">,</span><span> </span><a name="_fsHabs"><a href="Egg.Farm.html#_fsHabs"><span class="hs-identifier">_fsHabs</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><a href="Egg.Habitat.html#HabStatus"><span class="hs-identifier hs-type">HabStatus</span></a><span> </span><a href="#local-6989586621680043740"><span class="hs-identifier hs-type">habs</span></a><span>
</span><a name="line-54"></a><span>                  </span><span class="hs-special">,</span><span> </span><a name="_fsDepot"><a href="Egg.Farm.html#_fsDepot"><span class="hs-identifier">_fsDepot</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><a href="Egg.Vehicle.html#SomeDepotStatus"><span class="hs-identifier hs-type">SomeDepotStatus</span></a><span> </span><a href="#local-6989586621680043741"><span class="hs-identifier hs-type">vehicles</span></a><span>
</span><a name="line-55"></a><span>                  </span><span class="hs-special">,</span><span> </span><a name="_fsBocks"><a href="Egg.Farm.html#_fsBocks"><span class="hs-identifier">_fsBocks</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><a href="Egg.Commodity.html#Bock"><span class="hs-identifier hs-type">Bock</span></a><span>
</span><a name="line-56"></a><span>                  </span><span class="hs-special">,</span><span> </span><a name="_fsGoldenEggs"><a href="Egg.Farm.html#_fsGoldenEggs"><span class="hs-identifier">_fsGoldenEggs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Egg.Commodity.html#GoldenEgg"><span class="hs-identifier hs-type">GoldenEgg</span></a><span>
</span><a name="line-57"></a><span>                  </span><span class="hs-special">,</span><span> </span><a name="_fsSoulEggs"><a href="Egg.Farm.html#_fsSoulEggs"><span class="hs-identifier">_fsSoulEggs</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Egg.Commodity.html#SoulEgg"><span class="hs-identifier hs-type">SoulEgg</span></a><span>
</span><a name="line-58"></a><span>                  </span><span class="hs-special">}</span><span>
</span><a name="line-59"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Egg.Farm.html#FarmStatus"><span class="hs-identifier hs-type">FarmStatus</span></a><span> </span><a href="#local-6989586621680043737"><span class="hs-identifier hs-type">eggs</span></a><span> </span><span class="hs-char">'(tiers, epic) habs vehicles

deriving instance ListC (Show &lt;$&gt; (Flip SV.Vector Natural &lt;$&gt; tiers))
    =&gt; Show (FarmStatus eggs '(tiers, epic) habs vehicles)
deriving instance ListC (Eq &lt;$&gt; (Flip SV.Vector Natural &lt;$&gt; tiers))
    =&gt; Eq (FarmStatus egg '(tiers, epic) habs vehicles)
deriving instance (ListC (Eq &lt;$&gt; (Flip SV.Vector Natural &lt;$&gt; tiers)), ListC (Ord &lt;$&gt; (Flip SV.Vector Natural &lt;$&gt; tiers)))
    =&gt; Ord (FarmStatus egg '(tiers, epic) habs vehicles)

fsEgg :: Lens (FarmStatus e1 '(t, g) h v) (FarmStatus e2 '(t, g) h v) (Finite e1) (Finite e2)
fsEgg f fs = (\e -&gt; fs { _fsEgg = e }) &lt;$&gt; f (_fsEgg fs)
fsResearch :: Lens (FarmStatus e '(t1, g1) h v) (FarmStatus e '(t2, g2) h v) (ResearchStatus t1 g1) (ResearchStatus t2 g2)
fsResearch f fs = f (_fsResearch fs) &lt;&amp;&gt; \r -&gt;
    (FarmStatus &lt;$&gt; _fsEgg
                &lt;*&gt; pure r
                &lt;*&gt; _fsHabs
                &lt;*&gt; _fsDepot
                &lt;*&gt; _fsBocks
                &lt;*&gt; _fsGoldenEggs
                &lt;*&gt; _fsSoulEggs
    ) fs
fsHabs :: Lens (FarmStatus e '(t, g) h1 v) (FarmStatus e '(t, g) h2 v) (HabStatus h1) (HabStatus h2)
fsHabs f fs = (\h -&gt; fs { _fsHabs = h }) &lt;$&gt; f (_fsHabs fs)
fsDepot :: Lens (FarmStatus e '(t, g) h v1) (FarmStatus e '(t, g) h v2) (SomeDepotStatus v1) (SomeDepotStatus v2)
fsDepot f fs = (\d -&gt; fs { _fsDepot = d }) &lt;$&gt; f (_fsDepot fs)
fsBocks :: Lens' (FarmStatus e '(t, g) h v) Bock
fsBocks f fs = (\b -&gt; fs { _fsBocks = b }) &lt;$&gt; f (_fsBocks fs)
fsGoldenEggs :: Lens' (FarmStatus e '(t, g) h v) GoldenEgg
fsGoldenEggs f fs = (\e -&gt; fs { _fsGoldenEggs = e }) &lt;$&gt; f (_fsGoldenEggs fs)
fsSoulEggs :: Lens' (FarmStatus e '(t, g) h v) SoulEgg
fsSoulEggs f fs = (\s -&gt; fs { _fsSoulEggs = s }) &lt;$&gt; f (_fsSoulEggs fs)

initFarmStatus
    :: (KnownNat eggs, KnownNat habs, KnownNat vehicles, 1 TL.&lt;= eggs, 1 TL.&lt;= habs, 1 TL.&lt;= vehicles)
    =&gt; GameData   eggs '(tiers, epic) habs vehicles
    -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
initFarmStatus (GameData _ rd _ _ _) =
    FarmStatus 0
               (emptyResearchStatus rd)
               initHabStatus
               (known :=&gt; initDepotStatus)
               0
               0
               0

-- | Egg value
farmEggValue
    :: KnownNat eggs
    =&gt; GameData   eggs '(tiers, epic) habs vehicles
    -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
    -&gt; Double
farmEggValue gd fs = gd ^. gdEggData
                         . _EggData
                         . ixSV (fs ^. fsEgg)
                         . eggValue
                         . bonusingFor (farmBonuses gd fs) BTEggValue

-- | Egg rate in eggs per second.
--
-- Multiplies 'farmLayingRatePerChicken' by the number of chickens, and
-- caps it based on the depot capacity.
farmLayingRate
    :: KnownNat vehicles
    =&gt; GameData   eggs '(tiers, epic) habs vehicles
    -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
    -&gt; Double
farmLayingRate gd fs =
    fs ^. to (farmLayingRatePerChicken gd)
        . to (* chickens)
        . to (max cap)
  where
    chickens :: Double
    chickens = fs ^. fsHabs . to (totalChickens (gd ^. gdHabData))
    cap :: Double
    cap = case fs ^. fsDepot of
      _ :=&gt; d -&gt; totalDepotCapacity (gd ^. gdVehicleData)
                                    (farmBonuses gd fs)
                                    d

-- | How many eggs are laid per second, per chicken.
farmLayingRatePerChicken
    :: GameData   eggs '(tiers, epic) habs vehicles
    -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
    -&gt; Double
farmLayingRatePerChicken gd fs =
    gd ^. gdConstants
        . gcBaseLayingRate
        . dividing 60
        . bonusingFor (farmBonuses gd fs) BTLayingRate

-- -- | Total income (bocks per second), per chicken.
-- farmIncomePerChicken
--     :: (KnownNat eggs, KnownNat vehicles)
--     =&gt; GameData   eggs '(tiers, epic) habs vehicles
--     -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
--     -&gt; Double
-- farmIncomePerChicken gd fs = fs ^. to (farmLayingRatePerChicken gd)
--                                  . to (* farmEggValue gd fs)
--                                  . to (* farmSoulEggBonus gd fs)

-- | Total income (bocks per second)
farmIncome
    :: (KnownNat eggs, KnownNat vehicles)
    =&gt; GameData   eggs '(tiers, epic) habs vehicles
    -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
    -&gt; Double
farmIncome gd fs = fs ^. to (farmLayingRate gd)
                       . to (* farmEggValue gd fs)
                       . to (* farmSoulEggBonus gd fs)

-- | Total bock income over a given small-ish period of time, assuming
-- no habs get filled up or depots get filled up in this time interval.
--
-- Time step should be small (dt^3 = 0) enough to avoid discontinuities,
-- but this function still takes into account quadratic growth due to dt^2
-- terms.
--
-- habSize(t) = initHabSize + growthRate * t
-- incomerate(t) = capped (habSize(t) * layingRate) * eggValue
--
-- Assuming capped:
--
-- incomerate(t) = (initHabSize + growthRate * t) * layingRate * eggValue
-- totalincome = [initHabSize * dt + 1/2 growthRate * dt^2] * layingRate * eggValue
--
-- Assuming uncapped:
--
-- incomerate(t) = capped (initHabSize * layingRate) * eggValue
-- totalincome = dt * capped (initHabSize * layingRate) * eggValue
--
farmIncomeDT
    :: (KnownNat eggs, KnownNat habs, KnownNat vehicles)
    =&gt; GameData   eggs '(tiers, epic) habs vehicles
    -&gt; IsCalm
    -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
    -&gt; Double     -- ^ small time step (dt^3 = 0)
    -&gt; Double
farmIncomeDT gd ic fs dt
    | initLaying &gt;= cap = dt * cap * eggVal
    | otherwise         = (initHabSize * dt + growthRate * dt * dt / 2)
                            * layingRate * eggVal
  where
    bs          = farmBonuses gd fs
    layingRate  = farmLayingRatePerChicken gd fs
    eggVal      = farmEggValue   gd fs
    initHabSize = fs ^. fsHabs . to (totalChickens (gd ^. gdHabData))
    growthRate  = fs ^. fsHabs . to (totalGrowthRate (gd ^. gdHabData) bs ic)
    initLaying  = layingRate * initHabSize
    cap         = case fs ^. fsDepot of
      _ :=&gt; d -&gt; totalDepotCapacity (gd ^. gdVehicleData)
                                    (farmBonuses gd fs)
                                    d

-- | Soul egg bonus
farmSoulEggBonus
    :: GameData   eggs '(tiers, epic) habs vehicles
    -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
    -&gt; Double
farmSoulEggBonus gd fs =
    gd ^. gdConstants
        . gcBaseSoulEggBonus
        . to (* (fs ^. fsSoulEggs . to fromIntegral))
        . bonusingFor (farmBonuses gd fs) BTSoulEggBonus

-- | Time until depots are full
--
-- TODO: increase bocks
waitTilDepotFull
    :: (KnownNat habs, KnownNat vehicles)
    =&gt; GameData   eggs '(tiers, epic) habs vehicles
    -&gt; IsCalm
    -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
    -&gt; WaitTilRes (FarmStatus eggs '(tiers, epic) habs vehicles)
waitTilDepotFull gd ic fs =
    fsHabs (waitTilPop (gd ^. gdHabData) bs ic (floor chickensAtCap)) fs
  where
    bs :: Bonuses
    bs = farmBonuses gd fs
    depotCap :: Double
    depotCap = case fs ^. fsDepot of
      _ :=&gt; d -&gt; totalDepotCapacity (gd ^. gdVehicleData) bs d
    chickensAtCap :: Double
    chickensAtCap = depotCap / farmLayingRatePerChicken gd fs

-- | Bonuses from a given 'GameData' and 'FarmStatus'
farmBonuses
    :: GameData   eggs '(tiers, epic) habs vehicles
    -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
    -&gt; Bonuses
farmBonuses gd fs = totalBonuses (gd ^. gdResearchData) (fs ^. fsResearch)

-- | Step the farm over a given time interval
--
-- TODO: properly manage quadratic bock increase
--
-- Should be += integral (R c(t)) dt
--   where c'(t) = rt
stepFarm
    :: forall eggs tiers epic habs vehicles. (KnownNat eggs, KnownNat habs, KnownNat vehicles)
    =&gt; GameData   eggs '(tiers, epic) habs vehicles
    -&gt; IsCalm
    -&gt; Double       -- ^ time interval to step
    -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
    -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
stepFarm gd ic dt0 fs0 = go dt0 fs0
  where
    traverseWait
        :: HabStatus habs
        -&gt; WriterT ((Fin N4, Double), Double) (Either HWaitError) (HabStatus habs)
    traverseWait = WriterT
                 . fmap swap
                 . waitTilNextFilled (gd ^. gdHabData) bs ic
    bs :: Bonuses
    bs = farmBonuses gd fs0
    go  :: Double
        -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
        -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
    go dt fs1 = case runWriterT $ fsHabs traverseWait fs1 of
      -- habs aren't growing
      Left  _                       -&gt;
            fs1 &amp; fsBocks +~ (farmIncome gd fs1 * dt)
      Right (fs2, ((_, tFill), rt))
        -- habs are growing but slow enough to not change in the interval
        | dt &lt; tFill -&gt;
            fs1 &amp; fsHabs . availableSpace (gd ^. gdHabData) bs . mapped -~ rt * dt
                &amp; fsBocks +~ farmIncomeDT gd ic fs1 dt
        -- habs are growing quickly enough to change in the interval
        | otherwise  -&gt; go (dt - tFill) $
            fs2 &amp; fsBocks +~ farmIncomeDT gd ic fs1 dt

-- | Step farm over a SMALL (infinitessimal) time step.  Assumes that
-- nothing discontinuous changes during the time inveral, including things
-- like:
--
-- 1. habs filling up
-- 2. depots filling up
--
-- Useful for stepping continuous simulations.
stepFarmDT
    :: forall eggs tiers epic habs vehicles. (KnownNat eggs, KnownNat habs, KnownNat vehicles)
    =&gt; GameData   eggs '(tiers, epic) habs vehicles
    -&gt; IsCalm
    -&gt; Double       -- ^ small (infinitessimal) time interval to step
    -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
    -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
stepFarmDT gd ic dt fs = fs
    &amp; fsHabs  %~ stepHabs (gd ^. gdHabData) (farmBonuses gd fs) ic dt
    &amp; fsBocks +~ farmIncomeDT gd ic fs dt

-- waitUntilBocks
--     :: forall eggs tiers epic habs vehicles. (KnownNat eggs, KnownNat habs, KnownNat vehicles)
--     =&gt; GameData   eggs '(tiers, epic) habs vehicles
--     -&gt; IsCalm
--     -&gt; Bock       -- ^ goal
--     -&gt; FarmStatus eggs '(tiers, epic) habs vehicles
--     -&gt; Maybe (Double, FarmStatus eggs '(tiers, epic) habs vehicles)
-- waitUntilBocks = _
</span></pre></body></html>